name: GPU CI

on:
  workflow_dispatch:  # Manual trigger only
  # Automatic GPU testing disabled to reduce CI overhead
  # Uncomment below to re-enable automatic runs:
  # push:
  #   branches: [main, develop]
  # pull_request:
  #   branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  gpu-smoke-test:
    name: GPU Smoke Test (CUDA)
    runs-on: [self-hosted, linux, x64, gpu-1]
    strategy:
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python (fresh venv)
        run: |
          python3 -m venv gpu_test_venv
          source gpu_test_venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          echo "VIRTUAL_ENV=$(pwd)/gpu_test_venv" >> $GITHUB_ENV
          echo "$(pwd)/gpu_test_venv/bin" >> $GITHUB_PATH

      - name: Install build dependencies
        run: |
          source gpu_test_venv/bin/activate
          pip install setuptools>=68 wheel build

      - name: Install runtime dependencies (GPU - CUDA 12.8)
        run: |
          source gpu_test_venv/bin/activate
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu128
          pip install -r requirements.txt

      - name: Verify CUDA availability
        run: |
          source gpu_test_venv/bin/activate
          python -c "import torch; print(f'PyTorch version: {torch.__version__}'); print(f'CUDA available: {torch.cuda.is_available()}'); print(f'CUDA device count: {torch.cuda.device_count()}')"

      - name: Build and install package from source
        run: |
          source gpu_test_venv/bin/activate
          pip install -e . --no-build-isolation

      - name: Run CUDA GPU smoke test
        run: |
          source gpu_test_venv/bin/activate
          python scripts/gpu_smoke_test.py

      - name: Cleanup
        if: always()
        run: |
          rm -rf gpu_test_venv
